<!doctype html>
<html lang="bn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>একাউন্ট তৈরি করুন</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; padding-top: 50px; }
        .container { max-width: 450px; width: 100%; margin: auto; background: white; padding: 20px 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { color: #1877f2; text-align: center; }
        .flash { padding: 1em; margin-bottom: 1em; border-radius: 5px; color: white; text-align: center; }
        .flash.success { background-color: #4CAF50; }
        .flash.error { background-color: #f44336; }
        .flash.info { background-color: #2196F3; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .btn-primary { background-color: #1877f2; color: white; }
        .btn-google { background-color: #db4437; color: white; }
        .divider { text-align: center; border-bottom: 1px solid #ccc; line-height: 0.1em; margin: 25px 0; }
        .divider span { background: #fff; padding: 0 10px; }
        .login-link { text-align: center; margin-top: 20px; }
        .login-link a { color: #1877f2; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>আপনার একাউন্ট তৈরি করুন</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="post">
            <label for="name">আপনার নাম</label>
            <input type="text" id="name" name="name" required>
            
            <label for="email">আপনার ইমেইল</label>
            <input type="email" id="email" name="email" required>

            <label for="password">একটি পাসওয়ার্ড দিন</label>
            <input type="password" id="password" name="password" required>

            <label for="referrer_code">রেফার কোড (যদি থাকে)</label>
            <input type="text" id="referrer_code" name="referrer_code" value="{{ ref_code }}">
            
            <button type="submit" class="btn-primary">সাইন আপ</button>
        </form>
        
        <div class="divider"><span>অথবা</span></div>

        <button id="google-signup-btn" class="btn-google">
            <i class="fab fa-google"></i> Google দিয়ে সাইন আপ করুন
        </button>

        <div class="login-link">
            <p>ஏற்கனவே ஒரு கணக்கு உள்ளதா? <a href="{{ url_for('login') }}">এখানে লগইন করুন</a></p>
        </div>
    </div>

    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
        // আপনার Firebase প্রজেক্টের কনফিগারেশন। এটি সার্ভার থেকে রেন্ডার হবে।
        // login.html এর মতো একই কনফিগারেশন এখানেও ব্যবহার করতে হবে।
        // নিরাপত্তার জন্য এই কী-গুলো সার্ভার থেকে আনা ভালো, যা app.py তে করা আছে।
        const firebaseConfig = {
            apiKey: "{{ firebase_api_key }}", // app.py থেকে আসবে
            authDomain: "{{ os.getenv('FIREBASE_PROJECT_ID') }}.firebaseapp.com",
            projectId: "{{ os.getenv('FIREBASE_PROJECT_ID') }}",
            // বাকি কী-গুলোও প্রয়োজন হলে যুক্ত করতে হবে
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Google Sign-Up/Sign-In
        document.getElementById('google-signup-btn').addEventListener('click', function() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    return result.user.getIdToken();
                })
                .then((idToken) => {
                    // সাইনআপ পেইজ থেকে রেফারেল কোড সংগ্রহ করা
                    const referrerCode = document.getElementById('referrer_code').value;
                    
                    // সার্ভারের API তে টোকেন এবং রেফার কোড পাঠানো
                    return fetch('/api/auth/google', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            idToken: idToken,
                            referrerCode: referrerCode
                        })
                    });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.href = data.redirect_url; // ড্যাশবোর্ডে রিডাইরেক্ট
                    } else {
                        alert('Google সাইন আপ ব্যর্থ হয়েছে: ' + data.message);
                    }
                })
                .catch((error) => {
                    console.error("Google Sign-Up Error: ", error);
                    alert("একটি সমস্যা হয়েছে: " + error.message);
                });
        });
    </script>
</body>
              </html>
