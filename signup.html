<!-- signup.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Account</title>
    <link rel="stylesheet" href="style.css">
    <!-- Supabase লাইব্রেরি -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body onload="checkUser()">
    <div class="container">
        <h2>Create Account</h2>
        <input type="text" id="fullName" placeholder="Full Name" required>
        <input type="email" id="email" placeholder="Email" required>
        <input type="text" id="phoneNumber" placeholder="Phone Number" required>
        <input type="number" id="age" placeholder="Age" required>
        <input type="password" id="password" placeholder="Password (min. 6 characters)" required>
        <button id="signupButton">Sign Up</button>
        <p>Already have an account? <a href="index.html">Login</a></p>
    </div>

    <!-- আমাদের JavaScript ফাইলগুলো -->
    <script src="main.js"></script>
    <script>
        document.getElementById('signupButton').addEventListener('click', async () => {
            // ফর্ম থেকে সব ডেটা নেওয়া
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const age = document.getElementById('age').value;
            const password = document.getElementById('password').value;

            // URL থেকে রেফারেল কোড চেক করা
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            let referredByUserId = null;

            if (refCode) {
                // রেফারারকে খুঁজে বের করে কমিশন দেওয়া
                const { data: referrer, error: refError } = await supabase
                    .from('profiles')
                    .select('id, balance')
                    .eq('referral_code', refCode)
                    .single();
                
                if (referrer) {
                    referredByUserId = referrer.id;
                    const newBalance = referrer.balance + 10;
                    await supabase.from('profiles').update({ balance: newBalance }).eq('id', referrer.id);
                }
            }

            // Supabase Auth-এ নতুন ইউজার তৈরি করা
            const { user, error: signUpError } = await supabase.auth.signUp({
                email: email,
                password: password,
            });

            if (signUpError) return alert('Error signing up: ' + signUpError.message);
            
            // ইউনিক রেফারেল কোড তৈরি করা
            const referralCode = 'REF' + Math.random().toString(36).substring(2, 8).toUpperCase();

            // `profiles` টেবিলে ইউজারের বাকি তথ্য সেভ করা
            const { error: profileError } = await supabase
                .from('profiles')
                .insert([{
                    id: user.id,
                    full_name: fullName,
                    email: email,
                    phone_number: phoneNumber,
                    age: age,
                    referral_code: referralCode,
                    referred_by: referredByUserId
                }]);

            if (profileError) return alert('Error creating profile: ' + profileError.message);
            
            alert('Signup successful! Please check your email to verify your account.');
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
